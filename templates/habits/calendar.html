<!-- calendar.html -->
{% extends "habits/base.html" %}
{% load static %}

{% block title %}Календарь привычек{% endblock %}
{% block header %}Календарь привычек{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="calendar-nav">
            <i class="fas fa-chevron-left"></i> {{ prev_month|date:"F Y" }}
        </a>
        <h2>{{ current_date|date:"F Y" }}</h2>
        <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="calendar-nav">
            {{ next_month|date:"F Y" }} <i class="fas fa-chevron-right"></i>
        </a>
    </div>

    <table class="calendar-table">
        <thead>
            <tr>
                <th>Пн</th>
                <th>Вт</th>
                <th>Ср</th>
                <th>Чт</th>
                <th>Пт</th>
                <th>Сб</th>
                <th>Вс</th>
            </tr>
        </thead>
        <tbody>
            {% for week in calendar %}
                <tr>
                    {% for day in week %}
                        <td class="{% if day.day == 0 %}empty{% else %}day{% endif %}"
                            {% if day.day != 0 %}data-date="{{ day.date|date:'Y-m-d' }}"{% endif %}>
                            {% if day.day != 0 %}
                                <div class="day-number">{{ day.day }}</div>
                                <div class="day-habits">
                                    {% for habit in day.habits %}
                                        <div class="habit-badge {{ habit.color_class }} {% if habit.completed %}completed{% endif %}"
                                             data-completion-id="{{ habit.completion_id }}"
                                             data-habit-id="{{ habit.id }}">
                                            {{ habit.name }}
                                            <span class="remove-habit">×</span>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button class="add-habit-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно для добавления привычки -->
<div id="add-habit-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Добавить привычку</h3>
            <button class="close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-habit-form">
                <input type="hidden" id="selected-date" value="">
                <div class="form-group">
                    <label for="habit-select">Выберите привычку:</label>
                    <select id="habit-select" class="form-control">
                        {% for habit in user_habits %}
                            <option value="{{ habit.id }}">{{ habit.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Добавить</button>
            </form>
        </div>
    </div>
</div>

<style>
    /* Стили остаются такими же, как в вашем исходном коде */
    .calendar-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--bg-secondary);
        border-radius: var(--borderRadius);
        box-shadow: var(--shadow);
    }
    /* ... остальные стили ... */
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик клика по кнопке добавления привычки
    document.querySelectorAll('.add-habit-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const date = this.closest('td.day').dataset.date;
            document.getElementById('selected-date').value = date;
            document.getElementById('add-habit-modal').style.display = 'block';
        });
    });

    // Закрытие модального окна
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('add-habit-modal').style.display = 'none';
    });

    // Отправка формы добавления привычки
    document.getElementById('add-habit-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const habitId = document.getElementById('habit-select').value;
        const date = document.getElementById('selected-date').value;

        fetch(`/habits/${habitId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                date: date,
                completed: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при отправке запроса');
        });
    });

    // Удаление выполнения привычки
    document.querySelectorAll('.remove-habit').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const badge = this.closest('.habit-badge');
            const completionId = badge.dataset.completionId;

            if (confirm('Удалить эту привычку из выбранного дня?')) {
                fetch(`/habits/completions/${completionId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Произошла ошибка при отправке запроса');
                });
            }
        });
    });

    // Навигация по месяцам
    document.querySelectorAll('.calendar-nav').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = this.href;
        });
    });
});
</script>
{% endblock %}